---
title: "Plots"
author: "Moj"
date: "2026-02-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(tidyverse)

# -----------------------------
# Data
# -----------------------------
df_forest <- tribble(
  ~Outcome, ~Model, ~beta_mean, ~hdi_low, ~hdi_high, ~gamma,
  "Log10 Viral Load", "Adjusted",        -0.028,   -0.436,   0.359, 0.5,
  "Log10 Viral Load", "Adjusted + ADH",   0.017,   -0.365,   0.431, 0.5,
  "CD4 Count",        "Adjusted",      -148.399, -208.554, -87.992, 50,
  "CD4 Count",        "Adjusted + ADH", -152.973, -209.429, -94.478, 50,
  "Physical QoL",     "Adjusted",        -3.332,   -6.150,  -0.790, 2,
  "Physical QoL",     "Adjusted + ADH",  -3.567,   -6.339,  -0.964, 2,
  "Mental QoL",       "Adjusted",        -0.497,   -4.002,   2.968, 2,
  "Mental QoL",       "Adjusted + ADH",  -0.742,   -4.290,   2.803, 2
) %>%
  mutate(
    Outcome = factor(Outcome,
                     levels = c("Log10 Viral Load", "CD4 Count", "Physical QoL", "Mental QoL")),
    Model = factor(Model, levels = c("Adjusted", "Adjusted + ADH"))
  )

# -----------------------------
# Colors
# -----------------------------
navy <- "#1C2A39"
gold <- "#D4A017"

# -----------------------------
# Transform to clinically meaningful units (β/γ)
# -----------------------------
df_plot <- df_forest %>%
  mutate(
    beta_std = beta_mean / gamma,
    low_std  = hdi_low   / gamma,
    high_std = hdi_high  / gamma,
    label = case_when(
      Outcome == "CD4 Count" ~ sprintf("%.0f (%.0f, %.0f)", beta_mean, hdi_low, hdi_high),
      TRUE ~ sprintf("%.2f (%.2f, %.2f)", beta_mean, hdi_low, hdi_high)
    ),
    Outcome = fct_rev(Outcome)
  )

# -----------------------------
# Plot
# -----------------------------
p_std <- ggplot(df_plot, aes(x = beta_std, y = Outcome, color = Model, shape = Model)) +
  # Reference lines
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = 0.8, color = "grey30") +
  geom_vline(xintercept = c(-1, 1), linetype = "dotted", linewidth = 0.8, color = "grey50") +

  # Intervals + points
  geom_errorbarh(
    aes(xmin = low_std, xmax = high_std),
    position = position_dodge(width = 0.55),
    height = 0.20,
    linewidth = 1.1
  ) +
  geom_point(position = position_dodge(width = 0.55), size = 3.2) +

  # Labels (in original units)
   geom_text(
  aes(
    label = label,
    x = pmax(high_std, beta_std) + 0.12
  ),
  position = position_dodge(width = 0.55),
  hjust = 0,
  size = 3.6,
  color = "black",
  show.legend = FALSE
)+

  # Styling
  scale_color_manual(values = c("Adjusted" = navy, "Adjusted + ADH" = gold)) +
  scale_shape_manual(values = c("Adjusted" = 16, "Adjusted + ADH" = 17)) +

  scale_x_continuous(
    name = "Effect size in clinically meaningful units",
    breaks = seq(-4, 4, by = 1),
    expand = expansion(mult = c(0.06, 0.28))
  ) +

  labs(
    title = "Figure 1. Bayesian Estimates of the Association Between Baseline Hard Drug Use and Year 2 Clinical Outcomes",
    subtitle = "Points are posterior means; bars are 95% HPDIs. 
    Dashed line = no effect; dotted lines = ±γ.",
    y = NULL
  ) +

  theme_classic(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.y = element_text(face = "bold"),
    plot.subtitle = element_text(size = 10),
    plot.margin = margin(10, 40, 10, 10)
  ) +
  coord_cartesian(clip = "off")

p_std

```

ggsave(
  filename = "Figure_Bayesian_Effects.pdf",
  plot = p_std,
  width = 11,
  height = 7,
  units = "in"
)

