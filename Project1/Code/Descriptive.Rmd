


```{r}
# ============================================================
# BIOS6624 Project 1 - Script 01: Cleaning + Descriptives
# Purpose:
#   - Read raw data
#   - Recode special missing values
#   - Keep Year 0 and Year 2
#   - Create wide dataset
#   - Descriptives: duplicates, missingness, Table 1, plots, adherence
# Outputs (Data):
#   DataProcessed/df_year2_wide.rds
# df_year2_analysis_complete_outcomes.rds
# Outputs (Tables):
#   Results/Tables/participants_before_subsetting.csv
#   Results/Tables/dup_check.csv
#   Results/Tables/missingness_outcomes_year0_year2.csv
#   Results/Tables/Table1_clean_with_missing.rtf
# ============================================================
# -----------------------
# Libraries
# -----------------------
library(tidyverse)
library(readr)
library(dplyr)
library(tidyr)
library(forcats)
library(flextable)
library(officer)
library(ggplot2)


# ---- Paths ----
raw_path      <- "C:/Users/mojde/Desktop/Documents/BIOS-6624-Projects/Project1/DataRaw/hiv_6624_final.csv"
processed_dir <- "C:/Users/mojde/Desktop/Documents/BIOS-6624-Projects/Project1/DataProcessed"
results_tbl   <- "C:/Users/mojde/Desktop/Documents/BIOS-6624-Projects/Project1/Results/Tables"
results_fig   <- "C:/Users/mojde/Desktop/Documents/BIOS-6624-Projects/Project1/Results/Figures"

# Create folders if they don't exist (harmless if already exist)
dir.create(processed_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(results_tbl, recursive = TRUE, showWarnings = FALSE)
dir.create(results_fig, recursive = TRUE, showWarnings = FALSE)

# ---- Read raw data, blank as NA ----
df <- read_csv(raw_path, na = c("", " ", "NA"))

```

```{r}
# ============================================================
# 0) Total number of participants BEFORE subsetting (long OK)
# ============================================================
participants_summary <- bind_rows(
  
  # Overall
  df %>%
    summarise(
      years = "Overall",
      rows = n(),
      unique_participants = n_distinct(newid)
    ),
  
  # By year (including missing)
  df %>%
    mutate(years = if_else(is.na(years), "Missing", as.character(years))) %>%
    group_by(years) %>%
    summarise(
      rows = n(),
      unique_participants = n_distinct(newid),
      .groups = "drop"
    )
)

# View
participants_summary

# Save
write_csv(participants_summary,
          file.path(results_tbl, "participants_before_subsetting.csv"))

```





```{r}
# ============================================================
# 1) Cleaning / recodes
# ============================================================
df <- df %>%
  mutate(
    years = as.numeric(years),

    # special missing codes
    BMI = as.numeric(BMI),
    BMI = if_else(BMI %in% c(999, -1), NA_real_, BMI),

    # numeric outcomes/covariates
    across(c(VLOAD, LEU3N, AGG_PHYS, AGG_MENT, age), as.numeric),

    # exposure
    hard_drugs = factor(hard_drugs,
                        levels = c(0, 1),
                        labels = c("No", "Yes")),

    # collapse RACE
    RACE = as.numeric(RACE),
    RACE_collapsed = case_when(
      RACE == 1 ~ "White, non-Hispanic",
      RACE %in% c(2, 3, 4, 5, 6, 7, 8) ~ "Other race",
      TRUE ~ NA_character_
    ),
    RACE_collapsed = factor(RACE_collapsed,
                            levels = c("White, non-Hispanic", "Other race")),

    # collapse EDUCBAS
    EDUCBAS = as.numeric(EDUCBAS),
    EDU_collapsed = case_when(
      EDUCBAS %in% c(1, 2, 3, 4) ~ "No college degree",
      EDUCBAS %in% c(5, 6, 7) ~ "College and above",
      TRUE ~ NA_character_
    ),
    EDU_collapsed = factor(EDU_collapsed,
                           levels = c("No college degree", "College and above")),

    # Smoking
    SMOKE = factor(
      as.numeric(SMOKE),
      levels = c(1, 2, 3),
      labels = c("Never smoked", "Former smoker", "Current smoker")
    ),

    # Adherence (safer numeric extraction)
    ADH_num = as.numeric(as.character(ADH)),

    ADH = factor(
      ADH_num,
      levels = c(1, 2, 3, 4),
      labels = c("100%", "95–99%", "75–94%", "<75%")
    ),

    ADH_group = factor(
      case_when(
        ADH_num %in% c(1, 2) ~ "≥95%",
        ADH_num %in% c(3, 4) ~ "<95%",
        TRUE ~ NA_character_
      ),
      levels = c("≥95%", "<95%")
    )
  )
  
```



```{r}
# ============================================================
# 2) Keep only Year 0 and Year 2
# ============================================================
df_year2 <- df %>%
  filter(years %in% c(0, 2))

# Explore
colnames(df_year2)
glimpse(df_year2)
colSums(is.na(df_year2))
sapply(df_year2, class)
```



```{r}
# ============================================================
# 3) Select analysis variables (long)
# ============================================================
df_year2_selected <- df_year2 %>%
  select(
    newid, years,
    hard_drugs,
    VLOAD, LEU3N, AGG_PHYS, AGG_MENT,
    age, BMI,
    RACE_collapsed, EDU_collapsed, SMOKE,
    ADH_group
  )

```




```{r}
# ============================================================
# 4) Duplicate check (per id-year)
# ============================================================
dup_check <- df_year2_selected %>%
  count(newid, years) %>%
  count(n, name = "num_idyear_pairs") %>%
  rename(records_per_idyear = n)

write_csv(dup_check, file.path(results_tbl, "dup_check.csv"))
```



```{r}
# ============================================================
# 5) Long -> Wide (DO NOT log-transform VLOAD here)
#     LEU3N is CD4
# ============================================================
df_wide <- df_year2_selected %>%
  pivot_wider(
    id_cols = newid,
    names_from = years,
    values_from = -c(newid, years),
    names_sep = "_"
  ) %>%
  rename(
      HardDrugUse_baseline = hard_drugs_0,

    Age_baseline   = age_0,
    BMI_baseline   = BMI_0,
    RACE_baseline  = RACE_collapsed_0,
    EDU_baseline   = EDU_collapsed_0,
    Smoke_baseline = SMOKE_0,

    VLOAD_baseline = VLOAD_0,
    VLOAD_year2    = VLOAD_2,

    CD4_baseline   = LEU3N_0,
    CD4_year2      = LEU3N_2,

    PHYS_baseline  = AGG_PHYS_0,
    PHYS_year2     = AGG_PHYS_2,

    MENT_baseline  = AGG_MENT_0,
    MENT_year2     = AGG_MENT_2,

    ADH_year2      = ADH_group_2
  )

saveRDS(df_wide, file.path(processed_dir, "df_year2_wide.rds"))

```




```{r}
# ============================================================
# 6) Histogram to check skewness (all continuous variables)
# ============================================================
df_wide %>%
  select(
    VLOAD_baseline, VLOAD_year2,
    CD4_baseline, CD4_year2,
    PHYS_baseline, PHYS_year2,
    MENT_baseline, MENT_year2
  ) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Value") %>%
  mutate(
    Variable = factor(
      Variable,
      levels = c(
        "VLOAD_baseline", "VLOAD_year2",
        "CD4_baseline", "CD4_year2",
        "PHYS_baseline", "PHYS_year2",
        "MENT_baseline", "MENT_year2"
      ),
      labels = c(
        "Viral Load (Baseline)",
        "Viral Load (Year 2)",
        "CD4 Count (Baseline)",
        "CD4 Count (Year 2)",
        "Physical QOL (Baseline)",
        "Physical QOL (Year 2)",
        "Mental QOL (Baseline)",
        "Mental QOL (Year 2)"
      )
    )
  ) %>%
  ggplot(aes(x = Value)) +
  geom_histogram(bins = 30, fill = "#4C78A8", color = "white", alpha = 0.85) +
  facet_wrap(~Variable, scales = "free", ncol = 2) +
  labs(x = NULL, y = "Frequency") +
  theme_minimal(base_size = 12) +
  theme(strip.text = element_text(face = "bold"),
        panel.grid.minor = element_blank())

```

```{r}
# ============================================================
# 7) Create log10(VLOAD)
# ============================================================
df_wide <- df_wide %>%
  mutate(
    log10VLOAD_baseline = if_else(VLOAD_baseline > 0, log10(VLOAD_baseline), NA_real_),
    log10VLOAD_year2    = if_else(VLOAD_year2 > 0, log10(VLOAD_year2), NA_real_)
  )

saveRDS(df_wide, file.path(processed_dir, "df_wide.rds"))

```



```{r}
# ============================================================
# 8) Histogram: log10(VLOAD)
# ============================================================
df_wide %>%
  select(log10VLOAD_baseline, log10VLOAD_year2) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Value") %>%
  mutate(
    Variable = factor(
      Variable,
      levels = c("log10VLOAD_baseline", "log10VLOAD_year2"),
      labels = c("Baseline (Year 0)", "Year 2")
    )
  ) %>%
  ggplot(aes(x = Value)) +
  geom_histogram(bins = 30, fill = "#4C78A8", color = "white", alpha = 0.85) +
  facet_wrap(~Variable, scales = "free", ncol = 2) +
  labs(x = expression(log[10]*"(Viral Load)"), y = "Frequency") +
  theme_minimal(base_size = 12) +
  theme(strip.text = element_text(face = "bold"),
        panel.grid.minor = element_blank())

# Check baseline hard drug use missingness
table(df_wide$HardDrugUse_baseline, useNA = "ifany")
```

```{r}
#check number of missing harddruguse at baseline 
table(df_wide$HardDrugUse_baseline, useNA = "ifany")

```

```{r}
# ============================================================
# 9) Outlier check (IQR rule) for baseline continuous variables
# ============================================================
vars <- c(
  "Age_baseline",
  "BMI_baseline",
  "log10VLOAD_baseline",
  "CD4_baseline",
  "PHYS_baseline",
  "MENT_baseline"
)

df_long <- df_wide %>%
  select(newid, all_of(vars)) %>%
  pivot_longer(-newid, names_to = "Variable", values_to = "Value")

outliers <- df_long %>%
  group_by(Variable) %>%
  mutate(
    Q1 = quantile(Value, 0.25, na.rm = TRUE),
    Q3 = quantile(Value, 0.75, na.rm = TRUE),
    IQR_val = Q3 - Q1,
    Lower = Q1 - 1.5 * IQR_val,
    Upper = Q3 + 1.5 * IQR_val,
    Outlier = Value < Lower | Value > Upper
  ) %>%
  filter(Outlier == TRUE)

View(outliers)
```


```{r}
# ============================================================
# 10) Change BMI outliers to missing (after consulting with PI)
# ============================================================
df_wide <- df_wide %>%
  mutate(BMI_baseline = if_else(BMI_baseline > 70, NA_real_, BMI_baseline))

table(df_wide$HardDrugUse_baseline, useNA = "ifany")

```

```{r}
# ============================================================
# 11) Missingness of outcomes at Year 0 and Year 2 
# ============================================================
outcome_vars <- c(
  "log10VLOAD_baseline", "log10VLOAD_year2",
  "CD4_baseline", "CD4_year2",
  "PHYS_baseline", "PHYS_year2",
  "MENT_baseline", "MENT_year2"
)

missing_outcomes <- df_wide %>%
  summarise(across(all_of(outcome_vars), ~ sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Missing_N") %>%
  mutate(Missing_Pct = round(100 * Missing_N / nrow(df_wide), 1))

print(missing_outcomes)
write_csv(missing_outcomes, file.path(results_tbl, "missingness_outcomes_year0_year2.csv"))
```


```{r}
# ============================================================
# 12) Create analytic dataset (complete outcomes at Year 0 & Year 2)
# ============================================================
df_analysis <- df_wide %>%
  filter(if_all(all_of(outcome_vars), ~ !is.na(.)))

cat("N in df_wide:", nrow(df_wide), "\n")
cat("N in df_analysis:", nrow(df_analysis), "\n")

saveRDS(df_analysis, file.path(processed_dir, "df_year2_analysis_complete_outcomes.rds"))
```



```{r}
# ============================================================
#13) Table 1 (publication-style) using table1 package
# Stratified by baseline hard drug use + includes Total column
# Output: Results/Tables/Table1_baseline.html
# ============================================================
baseline_df <- df_analysis %>%
  filter(!is.na(HardDrugUse_baseline)) %>%
  mutate(
    Group = factor(HardDrugUse_baseline,
                   levels = c("No", "Yes"),
                   labels = c("No Hard Drug Use", "Hard Drug Use"))
  )

N_yes   <- sum(baseline_df$Group == "Hard Drug Use")
N_no    <- sum(baseline_df$Group == "No Hard Drug Use")
N_total <- nrow(baseline_df)

col_yes <- paste0("Hard Drug Use (N=", N_yes, ")")
col_no  <- paste0("No Hard Drug Use (N=", N_no, ")")
col_tot <- paste0("Overall (N=", N_total, ")")

msd <- function(x) sprintf("%.2f (%.2f)", mean(x, na.rm = TRUE), sd(x, na.rm = TRUE))
miss_n <- function(x) sum(is.na(x))

cont_vars <- list(
  "Age" = "Age_baseline",
  "Body Mass Index (kg/m²)" = "BMI_baseline",
  "Viral Load" = "log10VLOAD_baseline",
  "Number of CD4 Positive (cells/ml)" = "CD4_baseline",
  "Physical Quality of Life Score" = "PHYS_baseline",
  "Mental Quality of Life Score" = "MENT_baseline"
)

cont_table <- bind_rows(lapply(names(cont_vars), function(label) {
  var <- cont_vars[[label]]
  bind_rows(
    tibble(
      Variable = label,
      !!col_yes := msd(baseline_df %>% filter(Group == "Hard Drug Use") %>% pull(var)),
      !!col_no  := msd(baseline_df %>% filter(Group == "No Hard Drug Use") %>% pull(var)),
      !!col_tot := msd(baseline_df %>% pull(var))
    ),
    tibble(
      Variable = "   Missing",
      !!col_yes := as.character(miss_n(baseline_df %>% filter(Group == "Hard Drug Use") %>% pull(var))),
      !!col_no  := as.character(miss_n(baseline_df %>% filter(Group == "No Hard Drug Use") %>% pull(var))),
      !!col_tot := as.character(miss_n(baseline_df %>% pull(var)))
    )
  )
}))

cat_block <- function(var, label) {

  df_tmp <- baseline_df %>%
    mutate(Level = forcats::fct_explicit_na(.data[[var]], na_level = "Missing"))

  tab <- df_tmp %>%
    count(Group, Level) %>%
    tidyr::complete(Group, Level, fill = list(n = 0)) %>%  # ensures both groups exist
    pivot_wider(names_from = Group, values_from = n, values_fill = 0)

  total <- df_tmp %>% count(Level)

  tab <- left_join(tab, total, by = "Level")

  bind_rows(
    tibble(Variable = label, !!col_yes := "", !!col_no := "", !!col_tot := ""),
    tab %>%
      transmute(
        Variable = paste0("   ", Level),
        !!col_yes := as.character(`Hard Drug Use`),
        !!col_no  := as.character(`No Hard Drug Use`),
        !!col_tot := as.character(n)
      )
  )
}

smoke_block <- cat_block("Smoke_baseline", "Smoking")
edu_block   <- cat_block("EDU_baseline", "Education")
race_block  <- cat_block("RACE_baseline", "Race")

table1_final <- bind_rows(
  cont_table %>% slice(1:4),
  smoke_block,
  edu_block,
  race_block,
  cont_table %>% slice(5:nrow(cont_table))
)

View(table1_final)

ft <- flextable(table1_final) %>%
  autofit()

save_as_rtf(ft, path = file.path(results_tbl, "Table1_clean_with_missing.rtf"))
```



```{r}
# ============================================================
# 14) Adherence descriptives (Year 2)
# ============================================================

p <- df_wide %>%
  count(HardDrugUse_baseline, ADH_year2) %>%
  mutate(
    ADH_year2 = factor(ADH_year2, levels = c("≥95%", "<95%")),
    HardDrugUse_baseline = factor(
      HardDrugUse_baseline,
      levels = c("Yes", "No"),  # Hard Drug Use first
      labels = c("Hard Drug Use", "No Hard Drug Use")
    )
  ) %>%
  ggplot(aes(x = ADH_year2, y = n, fill = HardDrugUse_baseline)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(
    aes(label = n),
    position = position_dodge(width = 0.8),
    vjust = -0.3,
    size = 4.5
  ) +
  scale_fill_manual(values = c(
    "Hard Drug Use"    = "#1F3A5F",  # deep navy
    "No Hard Drug Use" = "#2A9D8F"   # teal
  )) +
  labs(
    x = "Adherence at Year 2",
    y = "Number of Participants",
    fill = NULL
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "top",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

p

```


```{r}
# ============================================================
# 12) Adherence descriptives (Year 2)
# ============================================================
table(df_wide$ADH_year2)
```




```{r}
# Flowchart
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)

flowchart <- grViz("
digraph flowchart {

  graph [layout = dot, rankdir = TB]

  node [shape = box,
        style = 'rounded,filled',
        fontname = Helvetica,
        fontsize = 13,
        color = '#1B3A4B',
        fillcolor = '#EEF3F6',
        penwidth = 1.2]

  edge [color = '#1B3A4B',
        penwidth = 1.1,
        arrowsize = 0.8]

  # Main nodes
  A [label = 'Longitudinal Multicenter AIDS Cohort Study \\nYears 0–8']

  B [label = 'Restrict to Year 0 (baseline) and Year 2\\nYear 0: n = 715\\nYear 2: n = 506']

  C [label = 'Reshape to wide format\\n(one record per participant)']

  D [label = 'Data management\\nRecode special missing codes\\nSet 3 BMI outliers (>70 kg/m²) to missing\\nLog₁₀-transform viral load\\nCollapse race & education categories']

  E [label = 'Eligibility: complete data for ALL outcomes\\nat baseline and Year 2\\n(log₁₀ viral load, CD4, physical QoL, mental QoL)\\nAnalytic sample: n = 476']

  F [label = 'Frequentist linear regression analyses\\n(n = 476)']

  G [label = 'Bayesian analyses\\nComplete-case for all model variables\\nFinal analytic sample: n = 463']

  # Exclusion node (defined to match Methods)
  X1 [label = 'Excluded:\\nIncomplete outcome data for eligibility definition\\n(missing any of the 4 outcomes at baseline or Year 2)\\n(n = 239)',
      fillcolor = '#F4F6F7',
      color = '#7B8A8B']

  # Main flow
  A -> B -> C -> D -> E -> F -> G

  # Exclusion from eligibility step
  B -> X1

  {rank=same; B X1}
}
")
```



```{r}
svg_txt <- export_svg(flowchart)  # returns SVG text
rsvg_png(charToRaw(svg_txt),
         file = "Flowchart.png",
         width = 3000, height = 4000)  # high-res
```